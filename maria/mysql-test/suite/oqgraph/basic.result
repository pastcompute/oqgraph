DROP TABLE IF EXISTS graph_base;
DROP TABLE IF EXISTS graph;
DROP TABLE IF EXISTS graph2;
CREATE TABLE graph2 (
latch   VARCHAR(32) NULL,
origid  BIGINT    UNSIGNED NULL,
destid  BIGINT    UNSIGNED NULL,
weight  DOUBLE    NULL,
seq     BIGINT    UNSIGNED NULL,
linkid  BIGINT    UNSIGNED NULL,
KEY (latch, origid, destid) USING HASH,
KEY (latch, destid, origid) USING HASH
) ENGINE=OQGRAPH DATA_TABLE='graph_base' ORIGID='from_id', DESTID='to_id';
SELECT * FROM graph2 WHERE latch='dijkstras' AND origid=1 AND destid=6;
ERROR 42S02: Table 'test.graph_base' doesn't exist
DROP TABLE graph2;
CREATE TABLE graph_base (
from_id INT UNSIGNED NOT NULL,
to_id INT UNSIGNED NOT NULL,
PRIMARY KEY (from_id,to_id),
INDEX (to_id)
) ENGINE=MyISAM;
CREATE TABLE graph (
latch   VARCHAR(32) NULL,
origid  BIGINT    UNSIGNED NULL,
destid  BIGINT    UNSIGNED NULL,
weight  DOUBLE    NULL,
seq     BIGINT    UNSIGNED NULL,
linkid  BIGINT    UNSIGNED NULL,
KEY (latch, origid, destid) USING HASH,
KEY (latch, destid, origid) USING HASH
) ENGINE=OQGRAPH DATA_TABLE='graph_base' ORIGID='from_id', DESTID='to_id';
INSERT INTO graph_base(from_id, to_id) VALUES (1,2), (2,1);
INSERT INTO graph_base(from_id, to_id) VALUES (1,3), (3,1);
INSERT INTO graph_base(from_id, to_id) VALUES (3,4), (4,3);
INSERT INTO graph_base(from_id, to_id) VALUES (5,6), (6,5);
SELECT * FROM graph WHERE latch = 'breadth_first' AND origid = 1 AND weight = 1;
latch	origid	destid	weight	seq	linkid
breadth_first	1	NULL	1	3	3
breadth_first	1	NULL	1	2	2
SELECT * FROM graph WHERE latch = '2' AND origid = 1 AND weight = 1;
latch	origid	destid	weight	seq	linkid
2	1	NULL	1	3	3
2	1	NULL	1	2	2
# Expect no result, because of autocast and deprecated syntax
SELECT * FROM graph WHERE latch = 2 AND origid = 1 AND weight = 1;
latch	origid	destid	weight	seq	linkid
# Expect no result between 1,6 because no connection exists
SELECT * FROM graph WHERE latch='dijkstras' AND origid=1 AND destid=6;
latch	origid	destid	weight	seq	linkid
SELECT * FROM graph WHERE latch='1' AND origid=1 AND destid=6;
latch	origid	destid	weight	seq	linkid
# Expect result between 4,1 because connection exists via 3
SELECT * FROM graph WHERE latch='dijkstras' AND origid=1 AND destid=4;
latch	origid	destid	weight	seq	linkid
dijkstras	1	4	NULL	0	1
dijkstras	1	4	1	1	3
dijkstras	1	4	1	2	4
SELECT * FROM graph WHERE latch='1' AND origid=1 AND destid=4;
latch	origid	destid	weight	seq	linkid
1	1	4	NULL	0	1
1	1	4	1	1	3
1	1	4	1	2	4
# and the reverse direction
SELECT * FROM graph WHERE latch='dijkstras' AND origid=4 AND destid=1;
latch	origid	destid	weight	seq	linkid
dijkstras	4	1	NULL	0	4
dijkstras	4	1	1	1	3
dijkstras	4	1	1	2	1
SELECT * FROM graph WHERE latch='1' AND origid=4 AND destid=1;
latch	origid	destid	weight	seq	linkid
1	4	1	NULL	0	4
1	4	1	1	1	3
1	4	1	1	2	1
SELECT * FROM graph WHERE latch='no_search' and destid=2 and origid=1;
latch	origid	destid	weight	seq	linkid
no_search	1	2	1	3	1
no_search	1	2	1	2	3
no_search	1	2	1	1	2
# Expect no result, because of autocast and deprecated syntax
SELECT * FROM graph WHERE latch=0 and destid=2 and origid=1;
latch	origid	destid	weight	seq	linkid
# Expect no result, because of NULL latch
SELECT * FROM graph WHERE latch=NULL and destid=2 and origid=1;
latch	origid	destid	weight	seq	linkid
# With no latch, original data, filtered by destid, etc if present
SELECT * FROM graph;
latch	origid	destid	weight	seq	linkid
NULL	1	2	1	NULL	NULL
NULL	2	1	1	NULL	NULL
NULL	1	3	1	NULL	NULL
NULL	3	1	1	NULL	NULL
NULL	3	4	1	NULL	NULL
NULL	4	3	1	NULL	NULL
NULL	5	6	1	NULL	NULL
NULL	6	5	1	NULL	NULL
SELECT * FROM graph WHERE destid=2 and origid=1;
latch	origid	destid	weight	seq	linkid
NULL	1	2	1	NULL	NULL
SELECT * FROM graph WHERE latch = 'breadth_first' AND origid = 1 AND (weight = 1 OR weight = 2);
latch	origid	destid	weight	seq	linkid
breadth_first	1	NULL	2	4	4
breadth_first	1	NULL	1	3	3
breadth_first	1	NULL	1	2	2
# Now we add a connection from 4->6 
INSERT INTO graph_base (from_id,to_id) VALUES (4,6);
# And delete all references to node 5
DELETE FROM graph_base WHERE from_id=5;
DELETE FROM graph_base WHERE from_id=3 AND to_id=5;
# which means there is a path in one direction only 1>3>4>6
SELECT * FROM graph WHERE latch='dijkstras' AND origid=1 AND destid=6;
latch	origid	destid	weight	seq	linkid
dijkstras	1	6	NULL	0	1
dijkstras	1	6	1	1	3
dijkstras	1	6	1	2	4
dijkstras	1	6	1	3	6
# but not 6>4>3>1
SELECT * FROM graph WHERE latch='dijkstras' AND origid=6 AND destid=1;
latch	origid	destid	weight	seq	linkid
DELETE FROM graph_base;
FLUSH TABLES;
TRUNCATE TABLE graph_base;
DROP TABLE graph_base;
SELECT * FROM graph WHERE latch='dijkstras' AND origid=1 AND destid=6;
ERROR 42S02: Table 'test.graph_base' doesn't exist
DROP TABLE graph;
